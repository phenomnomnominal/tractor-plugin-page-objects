<style
    ng-bind-html="$ctrl.style">
</style>
<div ng-if="$ctrl.fileModel">
    <tractor-file-tree
        extension="{{ $ctrl.extension }}"
        file-structure="$ctrl.fileStructure"
        create="$ctrl.createDirectory"
        delete="$ctrl.delete"
        move="$ctrl.move"
        file-style="$ctrl.fileStyle">
    </tractor-file-tree>
    <tractor-panel-handle panel-name="pageObject-file-tree"></tractor-panel-handle>
    <form class="file" name="$ctrl.fileEditor" novalidate
        ng-submit="$ctrl.showErrors() && $ctrl.saveFile()">
        <section class="file-options">
            <h1 class="file-options__name">{{ $ctrl.fileModel.name }}</h1>
            <div>
                <tractor-variable-input class="file-options__name-input"
                    ng-if="!$ctrl.fileModel.file"
                    form="file-editor"
                    label="Name"
                    model="$ctrl.fileModel"
                    example="Page Object"
                    is-class
                    all-variable-names="$ctrl.getAllVariableNames($ctrl.fileModel, $ctrl.fileModel)">
                </tractor-variable-input>
            </div>
            <div class="file-options__file-actions">
                <tractor-confirm-dialog trigger="$ctrl.confirmOverWrite">
                    <p>This will overwrite "{{ $ctrl.fileModel.name }}". Continue?</p>
                </tractor-confirm-dialog>
                <tractor-submit class="file-options__save-file"
                    action="Save page object file">
                </tractor-submit>
                <tractor-action class="file-options__new-file"
                    model="$ctrl"
                    action="New file">
                </tractor-action>
            </div>
        </section>

        <section class="file-editor">
            <section ng-show="$ctrl.fileModel.name">
                <section class="file-editor__container">
                    <h2>Elements:</h2>

                    <section ng-if="$ctrl.fileModel.domElements.length">
                        <ul>
                            <li class="file-editor__list-item"
                                ng-repeat="domElement in $ctrl.fileModel.domElements"
                                ng-class="{ 'file-editor__list-item--minimised': domElement.minimised }">

                                <h3 class="file-editor__list-item-name">{{ domElement.name }}</h3>

                                <tractor-action
                                    model="$ctrl.fileModel"
                                    action="Remove element"
                                    argument="domElement"
                                    icon="remove">
                                </tractor-action>

                                <tractor-action
                                    model="$ctrl"
                                    action="minimise"
                                    argument="domElement"
                                    icon="collapse">
                                </tractor-action>

                                <section
                                    class="file-editor__list-item--deprecated"
                                    ng-if="domElement.isDeprecated">
                                    <h3>The old way of selecting and filtering elements is deprecated.</h3>
                                    <h3>You need to re-create this element using CSS selectors.</h3>
                                    <br>
                                    <br>
                                    <tractor-variable-input
                                        form="file-editor"
                                        label="Name"
                                        model="domElement"
                                        example="element"
                                        all-variable-names="$ctrl.getAllVariableNames($ctrl.fileModel, domElement)">
                                    </tractor-variable-input>
                                    <tractor-select
                                        label="Selector"
                                        model="domElement.selector"
                                        required>
                                    </tractor-select>
                                    <tractor-text-input
                                        form="file-editor"
                                        label="Locator"
                                        model="domElement.selector"
                                        example="someController.someModel">
                                    </tractor-text-input>

                                    <section>
                                        <h3>Filters:</h3>

                                        <ol ng-if="domElement.filters.length > 1" as-sortable ng-model="domElement.sortableFilters" is-disabled="domElement.filters.length < 3">
                                            <li class="file-editor__list-item" ng-repeat="filter in domElement.sortableFilters" as-sortable-item>
                                                <tractor-action
                                                    model="domElement"
                                                    action="Remove filter"
                                                    argument="filter"
                                                    icon="remove">
                                                </tractor-action>
                                                <div class="file-editor__list-item-sort-handle" title="Drag to sort"
                                                     ng-if="domElement.filters.length > 2"
                                                     as-sortable-item-handle>
                                                </div>

                                                <tractor-select
                                                    ng-if="!domElement.filters[$index].isGroup"
                                                    label="selector"
                                                    model="filter"
                                                    required>
                                                </tractor-select>
                                                <tractor-text-input
                                                    form="file-editor"
                                                    label="Locator"
                                                    model="filter"
                                                    example="someController.someModel">
                                                </tractor-text-input>
                                            </li>
                                        </ol>

                                        <tractor-action
                                            model="domElement"
                                            action="Add filter">
                                        </tractor-action>
                                    </section>
                                </section>

                                <section
                                    ng-if="!domElement.isDeprecated">
                                    <tractor-variable-input
                                        form="file-editor"
                                        label="Name"
                                        model="domElement"
                                        example="element"
                                        all-variable-names="$ctrl.getAllVariableNames($ctrl.fileModel, domElement)">
                                    </tractor-variable-input>
                                    <tractor-text-input
                                        form="file-editor"
                                        label="selector"
                                        model="domElement"
                                        example="someController.someModel">
                                    </tractor-text-input>
                                    <tractor-checkbox
                                        label="Is Multiple"
                                        model="domElement">
                                    </tractor-checkbox>

                                    <section>
                                        <tractor-select
                                            ng-if="domElement.type"
                                            label="Type"
                                            as="name"
                                            options="domElement.pageObject.availablePageObjects"
                                            model="domElement"
                                            required>
                                        </tractor-select>

                                        <tractor-action
                                            ng-if="!domElement.type"
                                            model="domElement"
                                            action="Add type">
                                        </tractor-action>
                                    </section>
                                    <tractor-action
                                        ng-if="domElement.type"
                                        model="domElement"
                                        action="Remove type">
                                    </tractor-action>
                                </section>
                            </li>
                        </ul>
                    </section>

                    <tractor-action
                        model="$ctrl.fileModel"
                        action="Add element">
                    </tractor-action>
                </section>

                <section class="file-editor__container">
                    <h2>Actions:</h2>

                    <section ng-if="$ctrl.fileModel.actions.length">
                        <ul>
                            <li class="file-editor__list-item"
                                ng-repeat="action in $ctrl.fileModel.actions"
                                ng-class="{ 'file-editor__list-item--minimised': action.minimised }">

                                <h3 class="file-editor__list-item-name">{{ action.name }}</h3>

                                <tractor-action
                                    model="$ctrl.fileModel"
                                    action="Remove action"
                                    argument="action"
                                    icon="remove">
                                </tractor-action>

                                <tractor-action
                                    model="$ctrl"
                                    action="minimise"
                                    argument="action"
                                    icon="collapse">
                                </tractor-action>

                                <tractor-variable-input
                                    form="file-editor"
                                    label="Name"
                                    model="action"
                                    example="action"
                                    all-variable-names="$ctrl.getAllVariableNames($ctrl.fileModel, action)">
                                </tractor-variable-input>

                                <section>
                                    <h3>Parameters:</h3>

                                    <ol ng-if="action.parameters.length" as-sortable ng-model="action.parameters" is-disabled="action.parameters.length < 2">
                                        <li class="file-editor__list-item" ng-repeat="parameter in action.parameters" as-sortable-item>
                                            <tractor-action
                                                model="action"
                                                action="Remove parameter"
                                                argument="parameter"
                                                icon="remove">
                                            </tractor-action>
                                            <div ng-if="action.parameters.length > 1" class="file-editor__list-item-sort-handle" as-sortable-item-handle title="Drag to sort"></div>

                                            <tractor-variable-input
                                                form="file-editor"
                                                label="Name"
                                                model="parameter"
                                                example="parameter"
                                                all-variable-names="$ctrl.getAllParameterNames(action, parameter)">
                                            </tractor-variable-input>
                                        </li>
                                    </ol>

                                    <tractor-action
                                        model="action"
                                        action="Add parameter">
                                    </tractor-action>
                                </section>

                                <section>
                                    <h3>Interactions:</h3>

                                    <ol ng-if="action.interactions.length" as-sortable ng-model="action.interactions" is-disabled="action.interactions.length < 2">
                                        <li class="file-editor__list-item" ng-repeat="interaction in action.interactions" as-sortable-item>
                                            <tractor-action
                                                model="action"
                                                action="Remove interaction"
                                                argument="interaction"
                                                icon="remove">
                                            </tractor-action>
                                            <div ng-if="action.interactions.length > 1" class="file-editor__list-item-sort-handle" as-sortable-item-handle title="Drag to sort"></div>

                                            <tractor-select
                                                label="Element"
                                                model="interaction"
                                                options="$ctrl.fileModel.elements"
                                                as="name"
                                                required>
                                            </tractor-select>
                                            <tractor-literal-input
                                                ng-if="interaction.element.isMultiple"
                                                form="file-editor"
                                                name="interaction.selector.name"
                                                model="interaction.selector"
                                                description="interaction.selector.description"
                                                required="interaction.selector.required"
                                                type="interaction.selector.type">
                                            </tractor-literal-input>
                                            <tractor-select
                                                label="Action"
                                                model="interaction"
                                                options="interaction.element.actions"
                                                as="name"
                                                required>
                                            </tractor-select>

                                            <div ng-repeat="argument in interaction.actionInstance.arguments">
                                                <tractor-literal-input
                                                    form="file-editor"
                                                    name="argument.name"
                                                    model="argument"
                                                    description="argument.description"
                                                    required="argument.required"
                                                    type="argument.type">
                                                </tractor-literal-input>
                                            </div>
                                        </li>
                                    </ol>

                                    <tractor-action
                                        model="action"
                                        action="Add interaction">
                                    </tractor-action>
                                </section>
                            </li>
                        </ul>
                    </section>

                    <tractor-action
                        model="$ctrl.fileModel"
                        action="Add action">
                    </tractor-action>
                </section>

                <section
                    class="file-editor__container"
                    ng-if="$ctrl.fileModel.file.referencedBy.length">
                    <h2>Used by:</h2>

                    <ul
                        class="file-editor__list-item">
                        <li
                            ng-repeat="file in $ctrl.fileModel.file.referencedBy">
                            <a
                                ui-sref="tractor.file({ file: file })">{{ file.basename }}
                            </a>
                        </li>
                    </ul>
                </section>
            </section>
        </section>
    </form>
</div>
